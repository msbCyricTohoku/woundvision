{% extends "_base.html" %}

{% block title %}Analysis Results - {{ job_id }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="display-6">Analysis Results</h1>
        <p class="text-muted">Job ID: <span class="font-monospace">{{ job_id }}</span></p>
    </div>
    <a href="{{ url_for('download_results', job_id=job_id) }}" class="btn btn-success btn-lg">
        <i class="bi bi-download"></i> Download All as .zip
    </a>
</div>

{% if results['wound_metrics.csv'] %}
<div class="card shadow-sm mb-4">
    <div class="card-header fw-bold"><i class="bi bi-clipboard2-data-fill me-2"></i>Key Quantitative Metrics</div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover table-sm" id="metrics-table">
                <thead>
                    <tr><th>Loading metrics...</th></tr>
                </thead>
            </table>
        </div>
    </div>
</div>
{% endif %}

{% if results['prediction_with_metrics.png'] %}
<div class="card shadow-sm mb-4">
    <div class="card-header fw-bold">Overall Predictions</div>
    <div class="card-body">
        <div class="row">
            {% for file in results['prediction_with_metrics.png'] %}
            <div class="col-lg-6 mb-3">
                <a href="{{ file.url }}" target="_blank">
                    <img src="{{ file.url }}" class="img-fluid rounded border" alt="{{ file.name }}">
                </a>
                <p class="text-center mt-2">{{ file.name }}</p>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}

{% if results['area_trend_plot_instance0.png'] %}
<div class="card shadow-sm mb-4">
    <div class="card-header fw-bold">Area Trend (Instance 0)</div>
    <div class="card-body text-center">
        {% for file in results['area_trend_plot_instance0.png'] %}
        <a href="{{ file.url }}" target="_blank">
            <img src="{{ file.url }}" class="img-fluid rounded border" alt="{{ file.name }}" style="max-height: 500px;">
        </a>
        {% endfor %}
    </div>
</div>
{% endif %}

<div class="accordion" id="resultsAccordion">
    {% set categories = [
        ('Composite Visualizations', 'composite_visualizations', 'bi-distribute-vertical'),
        ('Heuristic Tissue Estimates', 'tissue_estimates', 'bi-palette-fill'),
        ('Healing Simulations (Erosion)', 'healing_simulations_erosion', 'bi-graph-down-arrow'),
        ('Healing Simulations (Distance)', 'healing_simulations_distance', 'bi-graph-down'),
        ('Pseudo-3D Plots', 'pseudo_3d_plots', 'bi-box'),
        ('Fractal Dimension Plots', 'fractal_dimension_plots', 'bi-pentagon'),
        ('Color Histograms', 'histograms', 'bi-bar-chart-line-fill'),
        ('Dominant Color Swatches', 'dominant_colors', 'bi-palette')
    ] %}

    {% for title, cat_key, icon in categories %}
    {% if results[cat_key] %}
    <div class="accordion-item">
        <h2 class="accordion-header">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-{{ cat_key }}">
                <i class="{{ icon }} me-2"></i> {{ title }}
            </button>
        </h2>
        <div id="collapse-{{ cat_key }}" class="accordion-collapse collapse" data-bs-parent="#resultsAccordion">
            <div class="accordion-body">
                <div class="row">
                    {% for file in results[cat_key] %}
                    <div class="col-md-4 col-lg-3 text-center mb-4">
                        <a href="{{ file.url }}" target="_blank">
                            <img src="{{ file.url }}" class="img-thumbnail" alt="{{ file.name }}">
                        </a>
                        <p class="mt-1 small">{{ file.name }}</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    {% endfor %}

    {% if results['wound_metrics.csv'] %}
    <div class="accordion-item">
        <h2 class="accordion-header">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-csv">
                <i class="bi bi-file-earmark-spreadsheet-fill me-2"></i> Raw Metrics Data (CSV)
            </button>
        </h2>
        <div id="collapse-csv" class="accordion-collapse collapse" data-bs-parent="#resultsAccordion">
            <div class="accordion-body">
                <p>The raw data is available in the downloadable zip file. A summary is also shown in the 'Key Quantitative Metrics' table at the top of the page.</p>
                {% for file in results['wound_metrics.csv'] %}
                 <a href="{{ file.url }}" class="btn btn-secondary"><i class="bi bi-download"></i> Download wound_metrics.csv</a>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const table = document.getElementById('metrics-table');
    {% if results['wound_metrics.csv'] %}
    // The url_for function generates the correct path to the results file
    const csvUrl = "{{ url_for('results_data', filename=job_id + '/wound_metrics.csv') }}";

    fetch(csvUrl)
        .then(response => {
            if (!response.ok) {
                throw new Error(`Network response was not ok: ${response.statusText}`);
            }
            return response.text();
        })
        .then(csvText => {
            // Clear the loading message
            table.innerHTML = ''; 
            
            const lines = csvText.trim().split(/\r?\n/); // Handles both windows and unix line endings
            if (lines.length < 2) {
                table.innerHTML = '<tr><td>No data found in metrics file.</td></tr>';
                return;
            }

            const headers = lines[0].split(',');
            const dataRows = lines.slice(1);

            // Create table header
            let thead = '<thead><tr>';
            headers.forEach(h => thead += `<th>${h.trim()}</th>`);
            thead += '</tr></thead>';
            table.insertAdjacentHTML('beforeend', thead);

            // Create table body
            let tbody = '<tbody>';
            dataRows.forEach(line => {
                const rowData = line.split(',');
                tbody += '<tr>';
                rowData.forEach(cell => tbody += `<td>${cell.trim()}</td>`);
                tbody += '</tr>';
            });
            tbody += '</tbody>';
            table.insertAdjacentHTML('beforeend', tbody);
        })
        .catch(error => {
            console.error('Error fetching or parsing CSV:', error);
            if(table) {
                table.innerHTML = '<thead><tr><th>Error</th></tr></thead><tbody><tr><td>Could not load metrics data.</td></tr></tbody>';
            }
        });
    {% endif %}
});
</script>
{% endblock %}